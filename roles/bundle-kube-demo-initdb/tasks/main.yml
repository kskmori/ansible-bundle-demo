- name: create NFS mount point
  file: path=/mnt/nfs state=directory

- name: mount NFS storage as a shared volume
  mount:
    path: /mnt/nfs
    src: "{{ NFS_SERVER }}:{{ NFS_EXPORT_DIR }}"
    fstype: nfs
    state: mounted

# create PGDATA of the container on the shared drive
# the directory name should be matched to the one generated by Pacemaker
# 26 is the postgres user id in the container
- name: create PGDATA on the shared drive
  file:
    path: /mnt/nfs/postgres-bundle-0
    state: directory
    owner: 26
    group: 26
    mode: 0700
  run_once: true

# the database initialization will be done by the script inside the container 
# giving --version option is to just exit after the initialization
- name: initialize the database
  command: docker run --name pg-init -v /mnt/nfs/postgres-bundle-0:/var/lib/pgsql/data {{ INSECURE_REGISTRY }}/pcmktest:postgres postgres --version
  run_once: true

- name: remove the initialization container
  command: docker rm pg-init
  run_once: true
  # TODO: better error handling not to leave pg-init when initdb failed
